import { LogUtil } from '@pura/harmony-utils'

/**
 * ä¼‘æ¯ViewModel - è´Ÿè´£ä¼‘æ¯å€’è®¡æ—¶é€»è¾‘
 * 
 * èŒè´£:
 * - ç®¡ç†ä¼‘æ¯å€’è®¡æ—¶çŠ¶æ€
 * - æ§åˆ¶ä¼‘æ¯å®šæ—¶å™¨
 * - é€šçŸ¥ä¼‘æ¯å®Œæˆ
 * 
 * @author kedongjun
 * @since 2025-01-27
 */
export class RestViewModel {
  // ============ é…ç½®å‚æ•° ============
  public restTime: number = 300
  
  // ============ çŠ¶æ€æ•°æ® ============
  public elapsedTime: number = 0
  public isResting: boolean = false
  
  // ============ å®šæ—¶å™¨ç®¡ç† ============
  private timerId: number = -1
  private lastTimestamp: number = 0
  private restStartTime: number = 0
  private readonly TICK_INTERVAL = 200
  
  // ============ å›è°ƒå‡½æ•° ============
  private onRestCompleteCallback?: () => void
  private onStateChangeCallback?: () => void
  
  // ğŸ†• æ·»åŠ ä¼‘æ¯åºå·
  private currentRestIndex: number = 0
  
  public onRestComplete(callback: () => void) {
    this.onRestCompleteCallback = callback
  }
  
  public onStateChange(callback: () => void) {
    this.onStateChangeCallback = callback
  }
  
  private notifyStateChange() {
    this.onStateChangeCallback?.()
  }
  
  /**
   * ğŸ†• è®¾ç½®å½“å‰ä¼‘æ¯åºå·
   */
  public setRestIndex(index: number) {
    this.currentRestIndex = index
  }
  
  /**
   * å¼€å§‹ä¼‘æ¯å€’è®¡æ—¶
   */
  public start(): void {
    if (this.timerId !== -1) {
      LogUtil.debug('RestClock: å·²åœ¨è¿è¡Œ,æ— æ³•å¯åŠ¨')
      return
    }
    
    LogUtil.debug('RestClock: å¼€å§‹ä¼‘æ¯å€’è®¡æ—¶')
    this.isResting = true
    this.elapsedTime = 0
    this.lastTimestamp = Date.now()
    this.restStartTime = Date.now()
    
    this.timerId = setInterval(() => {
      this.tick()
    }, this.TICK_INTERVAL)
  }
  
  private tick(): void {
    if (!this.isResting) {
      this.lastTimestamp = Date.now()
      return
    }
    
    const now = Date.now()
    this.elapsedTime = (now - this.restStartTime) / 1000
    this.lastTimestamp = now
    
    if (this.elapsedTime >= this.restTime) {
      this.handleRestComplete()
    }
    
    this.notifyStateChange()
  }
  
  private handleRestComplete(): void {
    LogUtil.debug('RestClock: ä¼‘æ¯å®Œæˆ')
    this.stop()
    this.isResting = false
    this.onRestCompleteCallback?.()
  }
  
  public skip(): void {
    LogUtil.debug('RestClock: è·³è¿‡ä¼‘æ¯')
    this.stop()
    this.isResting = false
    this.elapsedTime = 0
    this.restStartTime = 0
    this.onRestCompleteCallback?.()
  }
  
  public stop(): void {
    if (this.timerId !== -1) {
      clearInterval(this.timerId)
      this.timerId = -1
      LogUtil.debug('RestClock: åœæ­¢å®šæ—¶å™¨')
    }
  }
  
  public reset(): void {
    this.stop()
    this.elapsedTime = 0
    this.isResting = false
    this.restStartTime = 0
    this.notifyStateChange()
  }
  
  /**
   * ğŸ†• ä»ç¼“å­˜æ¢å¤å¹¶ç»§ç»­è¿è¡Œï¼ˆè®¾ç½®æ­£ç¡®çš„å¼€å§‹æ—¶é—´ï¼‰
   * @param elapsedSeconds å·²ç»è¿‡çš„ç§’æ•°
   */
  public restoreAndContinue(elapsedSeconds: number): void {
    LogUtil.debug(`RestClock: æ¢å¤å¹¶ç»§ç»­ï¼Œå·²ç”¨æ—¶${elapsedSeconds}ç§’`)
    
    // è®¾ç½®å½“å‰å·²ç”¨æ—¶é—´
    this.elapsedTime = elapsedSeconds
    
    // å…³é”®ï¼šè®¾ç½®ä¼‘æ¯å¼€å§‹æ—¶é—´ = ç°åœ¨ - å·²ç”¨æ—¶é—´
    this.restStartTime = Date.now() - elapsedSeconds * 1000
    
    // æ ‡è®°ä¸ºä¼‘æ¯ä¸­
    this.isResting = true
    
    // å¯åŠ¨å®šæ—¶å™¨
    this.start()
  }

  public checkAndSync(): boolean {
    if (this.timerId === -1 || !this.isResting) {
      return false
    }
    
    LogUtil.debug('RestClock: äº®å±æ ¡å‡†æ£€æŸ¥')
    
    const now = Date.now()
    this.elapsedTime = (now - this.restStartTime) / 1000
    
    if (this.elapsedTime >= this.restTime) {
      LogUtil.debug(`RestClock: æ ¡å‡†å‘ç°åº”å®Œæˆä¼‘æ¯,elapsed=${this.elapsedTime}ç§’`)
      this.handleRestComplete()
      return true
    }
    
    this.notifyStateChange()
    return false
  }
  
  public destroy(): void {
    this.stop()
    this.onRestCompleteCallback = undefined
    this.onStateChangeCallback = undefined
  }
}
