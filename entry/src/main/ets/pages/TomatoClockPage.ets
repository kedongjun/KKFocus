import { LogUtil } from '@pura/harmony-utils'
import promptAction from '@ohos.promptAction'
import { TomatoClockViewModel } from '../viewmodel/TomatoClockViewModel'
import { RestViewModel } from '../viewmodel/RestViewModel'
import { TomatoClock } from '../view/TomatoClock'
import { RestClock } from '../view/RestClock'


/**
 * ç•ªèŒ„é’Ÿé¡µé¢ - å®Œæ•´ç¤ºä¾‹ï¼ˆä½¿ç”¨SVGAæ‰©æ•£åœ†ç¯åŠ¨ç”»ï¼‰
 * 
 * @author kedongjun
 * @since 2025-01-27
 */
@Entry
@Component
struct TomatoClockPage {
  // ============ ViewModel ============
  private tomatoViewModel: TomatoClockViewModel = new TomatoClockViewModel()
  private restViewModel: RestViewModel = new RestViewModel()
  
  // ============ ç•ªèŒ„é’ŸçŠ¶æ€ ============
  @State tomatoNum: number = 4
  @State currentSegment: number = 0
  @State elapsedTime: number = 0
  @State segmentTime: number = 30
  @State isPaused: boolean = false
  @State isDone: boolean = false
  @State useTime: number = 0
  
  // ============ ä¼‘æ¯çŠ¶æ€ ============
  @State restTime: number = 10
  @State restElapsedTime: number = 0
  @State isResting: boolean = false
  
  aboutToAppear() {
    // ========== åˆå§‹åŒ–ç•ªèŒ„é’Ÿ ==========
    this.tomatoViewModel.tomatoNum = this.tomatoNum
    this.tomatoViewModel.segmentTime = this.segmentTime
    
    // è®¾ç½®çŠ¶æ€å˜åŒ–å›è°ƒ - ç”¨äºåŒæ­¥çŠ¶æ€åˆ°UI
    this.tomatoViewModel.onStateChange(() => {
      this.syncTomatoState()
    })
    
    // è®¾ç½®æ®µå®Œæˆå›è°ƒ - è¿›å…¥ä¼‘æ¯
    // æ³¨æ„ï¼šä½¿ç”¨ç»å¯¹æ—¶é—´æˆ³æ–¹æ¡ˆï¼Œå³ä½¿æ¯å±ä¹Ÿèƒ½å‡†ç¡®è§¦å‘
    this.tomatoViewModel.onSegmentComplete((current, total) => {
      LogUtil.debug(`å®Œæˆç¬¬ ${current}/${total} ä¸ªç•ªèŒ„`)
      
      if (current < total) {
        // è¿˜æœ‰å‰©ä½™ç•ªèŒ„ï¼Œè¿›å…¥ä¼‘æ¯
        this.enterRestMode()
      }
    })
    
    // è®¾ç½®å…¨éƒ¨å®Œæˆå›è°ƒ
    this.tomatoViewModel.onAllComplete(() => {
      LogUtil.debug('æ‰€æœ‰ç•ªèŒ„å®Œæˆï¼')
      promptAction.showToast({
        message: 'ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰ç•ªèŒ„ï¼',
        duration: 3000
      })
    })
    
    // ========== åˆå§‹åŒ–ä¼‘æ¯ ==========
    this.restViewModel.restTime = this.restTime
    
    // è®¾ç½®ä¼‘æ¯çŠ¶æ€å˜åŒ–å›è°ƒ
    this.restViewModel.onStateChange(() => {
      this.syncRestState()
    })
    
    // è®¾ç½®ä¼‘æ¯å®Œæˆå›è°ƒ - ç»§ç»­ä¸‹ä¸€ä¸ªç•ªèŒ„
    // æ³¨æ„ï¼šä½¿ç”¨ç»å¯¹æ—¶é—´æˆ³æ–¹æ¡ˆï¼Œå³ä½¿æ¯å±ä¹Ÿèƒ½å‡†ç¡®è§¦å‘
    this.restViewModel.onRestComplete(() => {
      LogUtil.debug('ä¼‘æ¯å®Œæˆ')
      this.exitRestMode()
    })
    
    // è‡ªåŠ¨å¼€å§‹ç¬¬ä¸€ä¸ªç•ªèŒ„
    this.tomatoViewModel.start()
  }
  
  aboutToDisappear() {
    this.tomatoViewModel.destroy()
    this.restViewModel.destroy()
  }
  
  /**
   * é¡µé¢æ˜¾ç¤º - å¤„ç†äº®å±åçš„æ—¶é—´æ ¡å‡†
   */
  onPageShow() {
    LogUtil.debug('======= é¡µé¢æ˜¾ç¤º - å¼€å§‹æ—¶é—´æ ¡å‡† =======')
    
    // å¯åŠ¨é€’å½’æ ¡å‡†ï¼Œç›´åˆ°æ‰€æœ‰åº”è¯¥å®Œæˆçš„é˜¶æ®µéƒ½å¤„ç†å®Œ
    this.recursiveSync()
  }
  
  /**
   * é€’å½’æ ¡å‡† - å¤„ç†æ‰€æœ‰åº”è¯¥å®Œæˆçš„ç•ªèŒ„å’Œä¼‘æ¯
   */
  private recursiveSync() {
    if (this.isDone) {
      LogUtil.debug('å·²å…¨éƒ¨å®Œæˆï¼Œåœæ­¢æ ¡å‡†')
      return
    }
    
    if (this.isResting) {
      // å½“å‰åœ¨ä¼‘æ¯ï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥å®Œæˆ
      const shouldContinue = this.restViewModel.checkAndSync()
      
      if (shouldContinue) {
        // ä¼‘æ¯å®Œæˆäº†ï¼Œä¼šè§¦å‘exitRestModeï¼Œç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªç•ªèŒ„
        setTimeout(() => {
          this.recursiveSync()
        }, 50)
      }
    } else {
      // å½“å‰åœ¨ç•ªèŒ„é’Ÿï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥å®Œæˆ
      const shouldContinue = this.tomatoViewModel.checkAndSync()
      
      if (shouldContinue) {
        // ç•ªèŒ„å®Œæˆäº†ï¼Œä¼šè§¦å‘enterRestModeï¼Œç»§ç»­æ£€æŸ¥ä¼‘æ¯
        setTimeout(() => {
          this.recursiveSync()
        }, 50)
      }
    }
  }
  
  /**
   * é¡µé¢éšè— - æ¯å±æˆ–åˆ‡åˆ°åå°
   */
  onPageHide() {
    LogUtil.debug('é¡µé¢éšè— - æ¯å±æˆ–åå°')
  }
  
  private syncTomatoState() {
    this.tomatoNum = this.tomatoViewModel.tomatoNum
    this.currentSegment = this.tomatoViewModel.currentSegment
    this.elapsedTime = this.tomatoViewModel.elapsedTime
    this.segmentTime = this.tomatoViewModel.segmentTime
    this.isPaused = this.tomatoViewModel.isPaused
    this.isDone = this.tomatoViewModel.isDone
    this.useTime = this.tomatoViewModel.useTime
  }
  
  private syncRestState() {
    this.restElapsedTime = this.restViewModel.elapsedTime
  }
  
  private enterRestMode() {
    LogUtil.debug('è¿›å…¥ä¼‘æ¯æ¨¡å¼')
    this.isResting = true
    
    // ç«‹å³å¯åŠ¨ä¼‘æ¯å€’è®¡æ—¶ - ä¼šè®¾ç½®restStartTime = Date.now()
    // å…³é”®ï¼šå³ä½¿ç†„å±ï¼Œä¼‘æ¯ViewModelä¹Ÿä¼šç‹¬ç«‹è®¡æ—¶
    this.restViewModel.start()
    
    promptAction.showToast({
      message: `å®Œæˆç¬¬ ${this.currentSegment} ä¸ªç•ªèŒ„ï¼ä¼‘æ¯ ${this.restTime} ç§’`,
      duration: 2000
    })
  }
  
  private exitRestMode() {
    LogUtil.debug('é€€å‡ºä¼‘æ¯æ¨¡å¼ï¼Œç»§ç»­ç•ªèŒ„é’Ÿ')
    this.isResting = false
    this.restViewModel.reset()
    
    // æ¢å¤ç•ªèŒ„é’Ÿ - resumeæ–¹æ³•ä¼šè‡ªåŠ¨è®¾ç½®æ–°çš„segmentStartTime
    // segmentStartTime = Date.now() - elapsedTime * 1000
    this.tomatoViewModel.resume()
    
    promptAction.showToast({
      message: 'å¼€å§‹æ–°çš„ç•ªèŒ„ï¼',
      duration: 1500
    })
  }
  
  private formatTotalTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600)
    const mins = Math.floor((seconds % 3600) / 60)
    const secs = Math.floor(seconds % 60)
    
    if (hours > 0) {
      return `${hours}æ—¶${mins}åˆ†${secs}ç§’`
    } else if (mins > 0) {
      return `${mins}åˆ†${secs}ç§’`
    } else {
      return `${secs}ç§’`
    }
  }
  
  build() {
    Stack() {
      if (this.isResting) {
        // ========== ä¼‘æ¯ç•Œé¢ï¼ˆSVGAæ‰©æ•£åŠ¨ç”»ï¼‰==========
        RestClock({
          restTime: this.restTime,
          elapsedTime: this.restElapsedTime,
          onSkip: () => {
            // ç‚¹å‡»"ç»“æŸ"æŒ‰é’® - è·³è¿‡ä¼‘æ¯
            this.restViewModel.skip()
          },
          onFinish: () => {
            // ç‚¹å‡»"ä¼‘æ¯å®Œæˆ"æŒ‰é’® - ç«‹å³ç»“æŸä¼‘æ¯
            this.restViewModel.skip()
          }
        })
      } else {
        // ========== ç•ªèŒ„é’Ÿç•Œé¢ ==========
        Column() {
          Text('ç•ªèŒ„é’Ÿä¸“æ³¨')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 40, bottom: 20 })
          
          TomatoClock({
            tomatoNum: this.tomatoNum,
            currentSegment: this.currentSegment,
            elapsedTime: this.elapsedTime,
            segmentTime: this.segmentTime
          })
            .margin({ top: 40, bottom: 40 })
          
          Column() {
            Text(`å½“å‰ï¼šç¬¬ ${this.currentSegment + 1}/${this.tomatoNum} ä¸ªç•ªèŒ„`)
              .fontSize(16)
              .margin({ bottom: 8 })
            
            Text(`æ€»ç”¨æ—¶ï¼š${this.formatTotalTime(this.useTime)}`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ bottom: 8 })
            
            Text(this.isDone ? 'âœ… å·²å®Œæˆ' : (this.isPaused ? 'â¸ï¸ å·²æš‚åœ' : 'â–¶ï¸ è¿›è¡Œä¸­'))
              .fontSize(14)
              .fontColor(this.isDone ? '#4CAF50' : (this.isPaused ? '#FF9800' : '#2196F3'))
          }
          .margin({ bottom: 40 })
          
          Row() {
            Button(this.isPaused ? 'ç»§ç»­' : 'æš‚åœ')
              .onClick(() => {
                this.tomatoViewModel.togglePause()
              })
              .enabled(!this.isDone)
              .margin({ right: 10 })
            
            Button('é‡ç½®')
              .onClick(() => {
                this.tomatoViewModel.reset()
                this.tomatoViewModel.start()
              })
              .margin({ right: 10 })
            
            Button('å»¶é•¿+1')
              .onClick(() => {
                this.tomatoViewModel.extend(1)
              })
          }
          .margin({ bottom: 20 })
          
          Column() {
            Divider().margin({ top: 20, bottom: 20 })
            
            Text('é…ç½®')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 10 })
            
            Row() {
              Text('ç•ªèŒ„æ—¶é•¿ï¼ˆç§’ï¼‰ï¼š')
              TextInput({ text: this.segmentTime.toString() })
                .width(100)
                .type(InputType.Number)
                .onChange((value) => {
                  const num = parseInt(value)
                  if (num > 0) {
                    this.segmentTime = num
                    this.tomatoViewModel.segmentTime = num
                  }
                })
            }
            .margin({ bottom: 10 })
            
            Row() {
              Text('ä¼‘æ¯æ—¶é•¿ï¼ˆç§’ï¼‰ï¼š')
              TextInput({ text: this.restTime.toString() })
                .width(100)
                .type(InputType.Number)
                .onChange((value) => {
                  const num = parseInt(value)
                  if (num > 0) {
                    this.restTime = num
                    this.restViewModel.restTime = num
                  }
                })
            }
            .margin({ bottom: 10 })
            
            Row() {
              Text('ç•ªèŒ„æ€»æ•°ï¼š')
              TextInput({ text: this.tomatoNum.toString() })
                .width(100)
                .type(InputType.Number)
                .onChange((value) => {
                  const num = parseInt(value)
                  if (num > 0) {
                    this.tomatoNum = num
                    this.tomatoViewModel.tomatoNum = num
                  }
                })
            }
            .margin({ bottom: 10 })
            
            Button('åº”ç”¨é…ç½®')
              .onClick(() => {
                this.tomatoViewModel.reset()
                this.tomatoViewModel.tomatoNum = this.tomatoNum
                this.tomatoViewModel.segmentTime = this.segmentTime
                this.tomatoViewModel.start()
              })
          }
          .padding(20)
          .width('90%')
          .backgroundColor('#F5F5F5')
          .borderRadius(10)
        }
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 180,
          colors: [[0x1a4d6d, 0.0], [0x0d2639, 1.0]]
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}

