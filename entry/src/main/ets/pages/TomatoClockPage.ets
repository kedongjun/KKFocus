import { LogUtil } from '@pura/harmony-utils'
import promptAction from '@ohos.promptAction'
import { TomatoClockViewModel } from '../viewmodel/TomatoClockViewModel'
import { RestViewModel } from '../viewmodel/RestViewModel'
import { TomatoClock } from '../view/TomatoClock'
import { RestClock } from '../view/RestClock'
import { ClockData, FocusDataUtil, FocusPreferenceName } from '../utils/FocusDataUtil'

// å®šä¹‰å‚æ•°ç±»åž‹
export interface RouterParams {
  tomatoNum: number,
  tomatoDuration: number,
  tomatoModel: number,
  isAutoRested: boolean,
  isStrict: boolean,
  title: string,
  restDuration: number,
}

/**
 * ç•ªèŒ„é’Ÿé¡µé¢ - å®Œæ•´ç¤ºä¾‹(ä½¿ç”¨SVGAæ‰©æ•£åœ†çŽ¯åŠ¨ç”»)
 * 
 * @author kedongjun
 * @since 2025-01-27
 */
@Entry
@Component
struct TomatoClockPage {
  // ============ ViewModel ============
  private tomatoViewModel: TomatoClockViewModel = new TomatoClockViewModel()
  private restViewModel: RestViewModel = new RestViewModel()
  
  // ============ ç•ªèŒ„é’ŸçŠ¶æ€ ============
  @State tomatoNum: number = this.tomatoViewModel.tomatoNum
  @State currentTomato: number = this.tomatoViewModel.currentTomato
  @State currentTomatoSeconds: number = this.tomatoViewModel.currentTomatoSeconds
  @State tomatoDuration: number = this.tomatoViewModel.tomatoDuration
  @State isPaused: boolean = this.tomatoViewModel.isPaused
  @State isTipRest: boolean = this.tomatoViewModel.isTipRest
  @State isDone: boolean = this.tomatoViewModel.isDone
  @State useTime: number = this.tomatoViewModel.useTime
  @State restDuration: number = this.tomatoViewModel.restDuration
  @State currentRest: number = this.tomatoViewModel.currentRest
  @State currentRestSeconds: number = this.tomatoViewModel.currentRestSeconds
  @State isResting: boolean = this.tomatoViewModel.isResting



  aboutToDisappear() {
    this.tomatoViewModel.destroy()
    this.restViewModel.destroy()
  }


  private syncUIFromViewModel(): void {
    const vm = this.tomatoViewModel

    // ====== é…ç½® & ç´¯è®¡æ•°æ®ï¼ˆä½ çŽ°åœ¨æ¼äº†ï¼‰======
    this.tomatoNum = vm.tomatoNum
    this.tomatoDuration = vm.tomatoDuration
    this.restDuration = vm.restDuration
    this.useTime = vm.useTime

    // ====== ç•ªèŒ„çŠ¶æ€ ======
    this.currentTomato = vm.currentTomato
    this.currentTomatoSeconds = vm.currentTomatoSeconds

    // ====== ä¼‘æ¯çŠ¶æ€ ======
    this.isResting = vm.isResting
    this.currentRest = vm.currentRest
    this.currentRestSeconds = vm.currentRestSeconds

    // ====== æŽ§åˆ¶çŠ¶æ€ ======
    this.isPaused = vm.isPaused
    this.isTipRest = vm.isTipRest
    this.isDone = vm.isDone
  }




  /**
   * é¡µé¢æ˜¾ç¤º - å¤„ç†äº®å±åŽçš„æ—¶é—´æ ¡å‡†
   */
  onPageShow() {
    LogUtil.debug('======= é¡µé¢æ˜¾ç¤º - å¼€å§‹æ—¶é—´æ ¡å‡† =======')
    this.tomatoViewModel.restoreClock()
    // åªåš UI ç»‘å®š
    this.syncUIFromViewModel()

    this.tomatoViewModel.ensureRunningIfNeeded()

  }



  private formatTotalTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600)
    const mins = Math.floor((seconds % 3600) / 60)
    const secs = Math.floor(seconds % 60)
    
    if (hours > 0) {
      return `${hours}æ—¶${mins}åˆ†${secs}ç§’`
    } else if (mins > 0) {
      return `${mins}åˆ†${secs}ç§’`
    } else {
      return `${secs}ç§’`
    }
  }
  
  build() {
    Stack() {
      if (this.isResting) {
        // ========== ä¼‘æ¯ç•Œé¢(SVGAæ‰©æ•£åŠ¨ç”»)==========
        RestClock({
          restTime: this.restDuration,
          elapsedTime: this.currentRestSeconds,
          onSkip: () => {
            this.restViewModel.skip()
          },
          onFinish: () => {
            this.restViewModel.skip()
          }
        })
      } else if (this.isDone) {
        // ðŸ†• ========== å»¶é•¿ç»„ä»¶ ==========
        Column() {
          Text('ðŸŽ‰ æ­å–œå®Œæˆ!')
            .fontSize(32)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 60, bottom: 40 })
          
          Column() {
            Text(`å·²å®Œæˆ ${this.tomatoNum} ä¸ªç•ªèŒ„`)
              .fontSize(20)
              .fontColor(Color.White)
              .margin({ bottom: 16 })
            
            Text(`æ€»ç”¨æ—¶: ${this.formatTotalTime(this.useTime)}`)
              .fontSize(18)
              .fontColor('#CCFFFFFF')
              .margin({ bottom: 40 })
            
            Text('ç»§ç»­ä¿æŒä¸“æ³¨?')
              .fontSize(16)
              .fontColor('#CCFFFFFF')
              .margin({ bottom: 24 })
            
            Row() {
              Button('å»¶é•¿ +1')
                .fontSize(16)
                .fontColor('#1a4d6d')
                .backgroundColor(Color.White)
                .width(120)
                .height(50)
                .borderRadius(25)
                .onClick(() => {
                  this.tomatoViewModel.extend(1)
                })
                .margin({ right: 15 })
              
              Button('å®Œæˆä»»åŠ¡')
                .fontSize(16)
                .fontColor(Color.White)
                .backgroundColor('rgba(255, 255, 255, 0.1)')
                .border({ width: 1, color: Color.White, radius: 25 })
                .width(120)
                .height(50)
                .onClick(() => {
                  // ðŸ†• å®Œæˆä»»åŠ¡,æ¸…ç©ºç¼“å­˜,è¿”å›žé¦–é¡µ
                  this.tomatoViewModel.finishTask()
                  
                  promptAction.showToast({
                    message: 'ä»»åŠ¡å·²å®Œæˆ!',
                    duration: 2000
                  })
                  
                  this.getUIContext().getRouter().back()
                })
            }
            .justifyContent(FlexAlign.Center)
          }
          .width('90%')
          .padding(30)
          .backgroundColor('rgba(255, 255, 255, 0.05)')
          .borderRadius(20)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .linearGradient({
          angle: 180,
          colors: [[0x1a4d6d, 0.0], [0x0d2639, 1.0]]
        })
      } else {
        // ========== ç•ªèŒ„é’Ÿç•Œé¢ ==========
        Column() {
          Text('ç•ªèŒ„é’Ÿä¸“æ³¨')
            .fontSize(24)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 40, bottom: 20 })
          
          TomatoClock({
            tomatoNum: this.tomatoNum,
            currentSegment: this.currentTomato,
            elapsedTime: this.currentTomatoSeconds,
            segmentTime: this.tomatoDuration
          })
            .margin({ top: 40, bottom: 40 })
          
          Column() {
            Text(`å½“å‰: ç¬¬ ${this.currentTomato}/${this.tomatoNum} ä¸ªç•ªèŒ„`)
              .fontSize(16)
              .fontColor(Color.White)
              .margin({ bottom: 8 })
            
            Text(`æ€»ç”¨æ—¶: ${this.formatTotalTime(this.useTime)}`)
              .fontSize(14)
              .fontColor('#CCFFFFFF')
              .margin({ bottom: 8 })
            
            Text(this.isDone ? 'âœ… å·²å®Œæˆ' : (this.isPaused ? 'â¸ï¸ å·²æš‚åœ' : 'â–¶ï¸ è¿›è¡Œä¸­'))
              .fontSize(14)
              .fontColor(this.isDone ? '#4CAF50' : (this.isPaused ? '#FF9800' : '#2196F3'))
          }
          .margin({ bottom: 40 })
          
          Row() {
            Button(this.isPaused ? 'ç»§ç»­' : 'æš‚åœ')
              .onClick(() => {
                this.tomatoViewModel.togglePause()
              })
              .enabled(!this.isDone)
              .margin({ right: 10 })
            
            Button('é‡ç½®')
              .onClick(() => {
                this.tomatoViewModel.reset()
                this.tomatoViewModel.start()
              })
              .margin({ right: 10 })
            
            Button('å»¶é•¿+1')
              .onClick(() => {
                this.tomatoViewModel.extend(1)
              })
          }
          .margin({ bottom: 20 })

        }
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 180,
          colors: [[0x1a4d6d, 0.0], [0x0d2639, 1.0]]
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}
