import { LogUtil } from '@pura/harmony-utils'
import promptAction from '@ohos.promptAction'
import { TomatoClockViewModel } from '../viewmodel/TomatoClockViewModel'
import { RestViewModel } from '../viewmodel/RestViewModel'
import { TomatoClock } from '../view/TomatoClock'
import { RestClock } from '../view/RestClock'
import { ClockData, FocusDataUtil, FocusPreferenceName } from '../utils/FocusDataUtil'

// å®šä¹‰å‚æ•°ç±»å‹
export interface RouterParams {
  tomatoNum: number,
  tomatoDuration: number,
  tomatoModel: number,
  isAutoRested: boolean,
  isStrict: boolean,
  title: string,
  restDuration: number,
}

/**
 * ç•ªèŒ„é’Ÿé¡µé¢ - å®Œæ•´ç¤ºä¾‹(ä½¿ç”¨SVGAæ‰©æ•£åœ†ç¯åŠ¨ç”»)
 * 
 * @author kedongjun
 * @since 2025-01-27
 */
@Entry
@Component
struct TomatoClockPage {
  // ============ ViewModel ============
  private tomatoViewModel: TomatoClockViewModel = new TomatoClockViewModel()
  private restViewModel: RestViewModel = new RestViewModel()

  // ============ ç•ªèŒ„é’ŸçŠ¶æ€ ============
  @State tomatoNum: number = this.tomatoViewModel.tomatoNum
  @State currentTomato: number = this.tomatoViewModel.currentTomato
  @State currentTomatoSeconds: number = this.tomatoViewModel.currentTomatoSeconds
  @State tomatoDuration: number = this.tomatoViewModel.tomatoDuration
  @State isPaused: boolean = this.tomatoViewModel.isPaused
  @State isTipRest: boolean = this.tomatoViewModel.isTipRest
  @State isDone: boolean = this.tomatoViewModel.isDone
  @State useTime: number = this.tomatoViewModel.useTime
  @State restDuration: number = this.tomatoViewModel.restDuration
  @State currentRest: number = this.tomatoViewModel.currentRest
  @State currentRestSeconds: number = this.tomatoViewModel.currentRestSeconds
  @State isResting: boolean = this.tomatoViewModel.isResting

  // ğŸ†• æ·»åŠ åˆå§‹åŒ–æ ‡å¿—
  private isFirstEnter: boolean = true

  // ğŸ†• æ·»åŠ  aboutToAppear æ–¹æ³•
  aboutToAppear(): void {
    LogUtil.debug('======= TomatoClockPage aboutToAppear =======')

    // 1ï¸âƒ£ è·å–è·¯ç”±å‚æ•°
    const params = this.getUIContext().getRouter().getParams() as RouterParams
    LogUtil.debug('è·¯ç”±å‚æ•°: ' + JSON.stringify(params))

    // 2ï¸âƒ£ æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤çŠ¶æ€
    const clockData = FocusDataUtil.getClockData(FocusPreferenceName.Tomato)
    const isResuming = clockData.startTimestamp !== 0

    if (isResuming) {
      // âœ… æ¢å¤åœºæ™¯ï¼šä»ç¼“å­˜æ¢å¤
      LogUtil.debug('æ£€æµ‹åˆ°ç¼“å­˜æ•°æ®ï¼Œæ¢å¤çŠ¶æ€')
      this.tomatoViewModel.restoreClock()
      this.syncUIFromViewModel()
      this.tomatoViewModel.ensureRunningIfNeeded()
    } else {
      // âœ… é¦–æ¬¡è¿›å…¥ï¼šä½¿ç”¨è·¯ç”±å‚æ•°åˆå§‹åŒ–
      LogUtil.debug('é¦–æ¬¡è¿›å…¥ï¼Œåˆå§‹åŒ–é…ç½®')

      if (params) {
        this.tomatoViewModel.tomatoNum = params.tomatoNum || 4
        this.tomatoViewModel.tomatoDuration = params.tomatoDuration || 25
        this.tomatoViewModel.tomatoModel = params.tomatoModel || 3
        this.tomatoViewModel.isAutoRested = params.isAutoRested || false
        this.tomatoViewModel.isStrict = params.isStrict || false
        this.tomatoViewModel.title = params.title || 'ç•ªèŒ„é’Ÿ'
        this.tomatoViewModel.restDuration = params.restDuration || 5
      }

      // 3ï¸âƒ£ åˆå§‹åŒ–ç¼“å­˜æ•°æ®
      this.tomatoViewModel.initClockData()

      // 4ï¸âƒ£ å¯åŠ¨ç•ªèŒ„é’Ÿ
      this.tomatoViewModel.start()

      // 5ï¸âƒ£ åŒæ­¥UI
      this.syncUIFromViewModel()
    }

    // 6ï¸âƒ£ æ³¨å†Œå›è°ƒ
    this.setupCallbacks()

    this.isFirstEnter = false
  }

  private setupCallbacks(): void {
    // ç•ªèŒ„å®Œæˆå›è°ƒ
    this.tomatoViewModel.onSegmentComplete((current, total) => {
      LogUtil.debug(`å®Œæˆç¬¬ ${current}/${total} ä¸ªç•ªèŒ„`)

      // åˆ¤æ–­æ˜¯å¦éœ€è¦ä¼‘æ¯
      if (this.tomatoViewModel.isAutoRested && current < total) {
        // è‡ªåŠ¨è¿›å…¥ä¼‘æ¯
        this.isResting = true
        this.restViewModel.restTime = this.restDuration * 60
        this.restViewModel.setRestIndex(current)
        this.restViewModel.start()

        // è®°å½•ä¼‘æ¯äº‹ä»¶
        this.tomatoViewModel.addFocusEvent(5, `å¼€å§‹ç¬¬${current}æ¬¡ä¼‘æ¯`, 0)
      } else if (!this.tomatoViewModel.isAutoRested && current < total) {
        // æç¤ºä¼‘æ¯
        this.isTipRest = true
      }

      this.syncUIFromViewModel()
    })

    // å…¨éƒ¨å®Œæˆå›è°ƒ
    this.tomatoViewModel.onAllComplete(() => {
      LogUtil.debug('æ‰€æœ‰ç•ªèŒ„å®Œæˆ')
      this.syncUIFromViewModel()

      // è®°å½•å®Œæˆäº‹ä»¶
      this.tomatoViewModel.addFocusEvent(9, 'å…¨éƒ¨å®Œæˆ', 0)
    })

    // çŠ¶æ€å˜åŒ–å›è°ƒ
    this.tomatoViewModel.onStateChange(() => {
      this.syncUIFromViewModel()
    })

    // ä¼‘æ¯å®Œæˆå›è°ƒ
    this.restViewModel.onRestComplete(() => {
      LogUtil.debug('ä¼‘æ¯å®Œæˆ')
      this.isResting = false
      this.currentRest++  // ğŸ”§ å¢åŠ ä¼‘æ¯è®¡æ•°

      // è®°å½•ä¼‘æ¯å®Œæˆäº‹ä»¶
      this.tomatoViewModel.addFocusEvent(8, `å®Œæˆç¬¬${this.currentRest}æ¬¡ä¼‘æ¯`, this.restDuration * 60)

      // âœ… å¼€å§‹ä¸‹ä¸€ä¸ªç•ªèŒ„
      if (this.currentTomato < this.tomatoNum) {
        this.tomatoViewModel.addFocusEvent(4, `å¼€å§‹ç¬¬${this.currentTomato + 1}ä¸ªç•ªèŒ„`, 0)
        this.tomatoViewModel.resume()  // ğŸ”§ è°ƒç”¨ resume è€Œä¸æ˜¯ start
      }

      this.syncUIFromViewModel()
    })

    // ä¼‘æ¯çŠ¶æ€å˜åŒ–å›è°ƒ
    this.restViewModel.onStateChange(() => {
      this.currentRestSeconds = this.restViewModel.elapsedTime
    })
  }

  /**
   * é¡µé¢æ˜¾ç¤º - å¤„ç†äº®å±åçš„æ—¶é—´æ ¡å‡†
   */
  onPageShow() {
    LogUtil.debug('======= TomatoClockPage onPageShow =======')

    // é¦–æ¬¡è¿›å…¥æ—¶å·²ç»åœ¨ aboutToAppear å¤„ç†äº†ï¼Œè¿™é‡Œè·³è¿‡
    if (this.isFirstEnter) {
      LogUtil.debug('é¦–æ¬¡è¿›å…¥ï¼Œè·³è¿‡ onPageShow å¤„ç†')
      return
    }

    // åç»­è¿›å…¥ï¼ˆä»åå°è¿”å›ï¼‰æ‰éœ€è¦æ¢å¤
    LogUtil.debug('ä»åå°è¿”å›ï¼Œæ ¡å‡†æ—¶é—´')
    this.tomatoViewModel.restoreClock()
    this.syncUIFromViewModel()
    this.tomatoViewModel.ensureRunningIfNeeded()
  }

  aboutToDisappear() {
    this.tomatoViewModel.destroy()
    this.restViewModel.destroy()
  }


  private syncUIFromViewModel(): void {
    const vm = this.tomatoViewModel

    // ====== é…ç½® & ç´¯è®¡æ•°æ®ï¼ˆä½ ç°åœ¨æ¼äº†ï¼‰======
    this.tomatoNum = vm.tomatoNum
    this.tomatoDuration = vm.tomatoDuration
    this.restDuration = vm.restDuration
    this.useTime = vm.useTime

    // ====== ç•ªèŒ„çŠ¶æ€ ======
    this.currentTomato = vm.currentTomato
    this.currentTomatoSeconds = vm.currentTomatoSeconds

    // ====== ä¼‘æ¯çŠ¶æ€ ======
    this.isResting = vm.isResting
    this.currentRest = vm.currentRest
    this.currentRestSeconds = vm.currentRestSeconds

    // ====== æ§åˆ¶çŠ¶æ€ ======
    this.isPaused = vm.isPaused
    this.isTipRest = vm.isTipRest
    this.isDone = vm.isDone
  }




  private formatTotalTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600)
    const mins = Math.floor((seconds % 3600) / 60)
    const secs = Math.floor(seconds % 60)
    
    if (hours > 0) {
      return `${hours}æ—¶${mins}åˆ†${secs}ç§’`
    } else if (mins > 0) {
      return `${mins}åˆ†${secs}ç§’`
    } else {
      return `${secs}ç§’`
    }
  }

  build() {
    Stack() {
      if (this.isResting) {
        // ========== ä¼‘æ¯ç•Œé¢(SVGAæ‰©æ•£åŠ¨ç”»)==========
        RestClock({
          restTime: this.restDuration,
          elapsedTime: this.currentRestSeconds,
          onSkip: () => {
            this.restViewModel.skip()
          },
          onFinish: () => {
            this.restViewModel.skip()
          }
        })
      }  else if (this.isTipRest) {
        // ğŸ†• ========== æç¤ºä¼‘æ¯ç•Œé¢ ==========
        Column() {
          Text('ğŸ‰ å®Œæˆä¸€ä¸ªç•ªèŒ„!')
            .fontSize(28)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 80, bottom: 40 })

          Text(`å·²å®Œæˆ ${this.currentTomato}/${this.tomatoNum} ä¸ªç•ªèŒ„`)
            .fontSize(18)
            .fontColor('#CCFFFFFF')
            .margin({ bottom: 60 })

          Text('éœ€è¦ä¼‘æ¯ä¸€ä¸‹å—ï¼Ÿ')
            .fontSize(16)
            .fontColor(Color.White)
            .margin({ bottom: 30 })

          Row() {
            Button('å¼€å§‹ä¼‘æ¯')
              .fontSize(16)
              .fontColor('#1a4d6d')
              .backgroundColor(Color.White)
              .width(120)
              .height(50)
              .borderRadius(25)
              .onClick(() => {
                // è¿›å…¥ä¼‘æ¯
                this.isTipRest = false
                this.isResting = true
                this.currentRest++
                this.restViewModel.restTime = this.restDuration * 60
                this.restViewModel.setRestIndex(this.currentRest)
                this.restViewModel.start()

                // è®°å½•ä¼‘æ¯äº‹ä»¶
                this.tomatoViewModel.addFocusEvent(5, `å¼€å§‹ç¬¬${this.currentRest}æ¬¡ä¼‘æ¯`, 0)
              })
              .margin({ right: 15 })

            Button('è·³è¿‡ä¼‘æ¯')
              .fontSize(16)
              .fontColor(Color.White)
              .backgroundColor('rgba(255, 255, 255, 0.1)')
              .border({ width: 1, color: Color.White, radius: 25 })
              .width(120)
              .height(50)
              .onClick(() => {
                // è·³è¿‡ä¼‘æ¯ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªç•ªèŒ„
                this.isTipRest = false

                if (this.currentTomato < this.tomatoNum) {
                  this.tomatoViewModel.addFocusEvent(4, `å¼€å§‹ç¬¬${this.currentTomato + 1}ä¸ªç•ªèŒ„`, 0)
                  this.tomatoViewModel.resume()
                }
              })
          }
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .linearGradient({
          angle: 180,
          colors: [[0x1a4d6d, 0.0], [0x0d2639, 1.0]]
        })
      } else if (this.isDone) {
        // ğŸ†• ========== å»¶é•¿ç»„ä»¶ ==========
        Column() {
          Text('ğŸ‰ æ­å–œå®Œæˆ!')
            .fontSize(32)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 60, bottom: 40 })

          Column() {
            Text(`å·²å®Œæˆ ${this.tomatoNum} ä¸ªç•ªèŒ„`)
              .fontSize(20)
              .fontColor(Color.White)
              .margin({ bottom: 16 })

            Text(`æ€»ç”¨æ—¶: ${this.formatTotalTime(this.useTime)}`)
              .fontSize(18)
              .fontColor('#CCFFFFFF')
              .margin({ bottom: 40 })

            Text('ç»§ç»­ä¿æŒä¸“æ³¨?')
              .fontSize(16)
              .fontColor('#CCFFFFFF')
              .margin({ bottom: 24 })

            Row() {
              Button('å»¶é•¿ +1')
                .fontSize(16)
                .fontColor('#1a4d6d')
                .backgroundColor(Color.White)
                .width(120)
                .height(50)
                .borderRadius(25)
                .onClick(() => {
                  this.tomatoViewModel.extend(1)
                })
                .margin({ right: 15 })

              Button('å®Œæˆä»»åŠ¡')
                .fontSize(16)
                .fontColor(Color.White)
                .backgroundColor('rgba(255, 255, 255, 0.1)')
                .border({ width: 1, color: Color.White, radius: 25 })
                .width(120)
                .height(50)
                .onClick(() => {
                  // ğŸ†• å®Œæˆä»»åŠ¡,æ¸…ç©ºç¼“å­˜,è¿”å›é¦–é¡µ
                  this.tomatoViewModel.finishTask()

                  promptAction.showToast({
                    message: 'ä»»åŠ¡å·²å®Œæˆ!',
                    duration: 2000
                  })

                  this.getUIContext().getRouter().back()
                })
            }
            .justifyContent(FlexAlign.Center)
          }
          .width('90%')
          .padding(30)
          .backgroundColor('rgba(255, 255, 255, 0.05)')
          .borderRadius(20)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .linearGradient({
          angle: 180,
          colors: [[0x1a4d6d, 0.0], [0x0d2639, 1.0]]
        })
      } else {
        // ========== ç•ªèŒ„é’Ÿç•Œé¢ ==========
        Column() {
          Text('ç•ªèŒ„é’Ÿä¸“æ³¨')
            .fontSize(24)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
            .margin({ top: 40, bottom: 20 })

          TomatoClock({
            tomatoNum: this.tomatoNum,
            currentSegment: this.currentTomato,
            elapsedTime: this.currentTomatoSeconds,
            segmentTime: this.tomatoDuration
          })
            .margin({ top: 40, bottom: 40 })

          Column() {
            Text(`å½“å‰: ç¬¬ ${this.currentTomato}/${this.tomatoNum} ä¸ªç•ªèŒ„`)
              .fontSize(16)
              .fontColor(Color.White)
              .margin({ bottom: 8 })

            Text(`æ€»ç”¨æ—¶: ${this.formatTotalTime(this.useTime)}`)
              .fontSize(14)
              .fontColor('#CCFFFFFF')
              .margin({ bottom: 8 })

            Text(this.isDone ? 'âœ… å·²å®Œæˆ' : (this.isPaused ? 'â¸ï¸ å·²æš‚åœ' : 'â–¶ï¸ è¿›è¡Œä¸­'))
              .fontSize(14)
              .fontColor(this.isDone ? '#4CAF50' : (this.isPaused ? '#FF9800' : '#2196F3'))
          }
          .margin({ bottom: 40 })

          Row() {
            Button(this.isPaused ? 'ç»§ç»­' : 'æš‚åœ')
              .onClick(() => {
                this.tomatoViewModel.togglePause()
              })
              .enabled(!this.isDone)
              .margin({ right: 10 })

            Button('é‡ç½®')
              .onClick(() => {
                this.tomatoViewModel.reset()
                this.tomatoViewModel.start()
              })
              .margin({ right: 10 })

            Button('å»¶é•¿+1')
              .onClick(() => {
                this.tomatoViewModel.extend(1)
              })
          }
          .margin({ bottom: 20 })

        }
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 180,
          colors: [[0x1a4d6d, 0.0], [0x0d2639, 1.0]]
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}
